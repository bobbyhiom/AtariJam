!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("@dcl/npc-scene-utils",["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["@dcl/npc-scene-utils"]={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,i)};function i(t,i){function o(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}function o(t,e,i,o){var n,r=arguments.length,s=r<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(s=(r<3?n(s):r>3?n(e,i,s):n(e,i))||s);return r>3&&s&&Object.defineProperty(e,i,s),s}function n(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],o=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&o>=t.length&&(t=void 0),{value:t&&t[o++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var r=function(){function t(t,e,i){this.lockXZRotation=!1,this.active=!1,s||(s=!0,engine.addSystem(new u)),this.lockXZRotation=t||!1,this.rotSpeed=e||2,i&&(this.active=!0)}return t=o([Component("trackUserFlag")],t)}(),s=!1,a=Camera.instance;var u=function(){function t(){this.followingNPCs=engine.getComponentGroup(r)}return t.prototype.update=function(t){var e,i;try{for(var o=n(this.followingNPCs.entities),s=o.next();!s.done;s=o.next()){var u=s.value,h=u.getComponent(Transform),l=u.getComponent(r);if(l.active){var c=new Vector3(a.position.x,a.position.y,a.position.z).subtract(h.position);h.rotation=Quaternion.Slerp(h.rotation,Quaternion.LookRotation(c),t*l.rotSpeed),l.lockXZRotation&&(h.rotation.x=0,h.rotation.z=0)}}}catch(t){e={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t}(),h=new UICanvas;h.visible=!0;var l,c,g=new Font(Fonts.SanFrancisco),p=new Font(Fonts.SanFrancisco_Heavy),d=new Texture("https://decentraland.org/images/ui/light-atlas-v2.png"),f=new Texture("https://decentraland.org/images/ui/dark-atlas-v2.png");function m(t,e){t.sourceWidth=e.sourceWidth,t.sourceHeight=e.sourceHeight,t.sourceLeft=e.sourceLeft?e.sourceLeft:0,t.sourceTop=e.sourceTop?e.sourceTop:0}function b(t){var e=-10-4*t;return e>-65?e:-65}(l=t.ButtonStyles||(t.ButtonStyles={})).E="e",l.F="f",l.DARK="dark",l.RED="red",l.ROUNDBLACK="roundblack",l.ROUNDWHITE="roundwhite",l.ROUNDSILVER="roundsilver",l.ROUNDGOLD="roundgold",l.SQUAREBLACK="squareblack",l.SQUAREWHITE="squarewhite",l.SQUARESILVER="squaresilver",l.SQUAREGOLD="squaregold",(c=t.NPCState||(t.NPCState={})).STANDING="standing",c.TALKING="talking",c.FOLLOWPATH="followPath";var y,T={buttons:{buttonE:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:662},buttonF:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:612},buttonRed:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:662},buttonDark:{sourceWidth:174,sourceHeight:46,sourceLeft:512,sourceTop:612},roundBlack:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:458},squareBlack:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:457},roundWhite:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:494},squareWhite:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:493},roundSilver:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:531},squareSilver:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:531},roundGold:{sourceWidth:128,sourceHeight:32,sourceLeft:512,sourceTop:567},squareGold:{sourceWidth:128,sourceHeight:32,sourceLeft:646,sourceTop:567}},buttonLabels:{E:{sourceWidth:26,sourceHeight:26,sourceLeft:697,sourceTop:611},F:{sourceWidth:26,sourceHeight:26,sourceLeft:733,sourceTop:611}},backgrounds:{promptBackground:{sourceWidth:416,sourceHeight:352,sourceLeft:501,sourceTop:12},promptLargeBackground:{sourceWidth:480,sourceHeight:384,sourceLeft:7,sourceTop:12},promptSlantedBackground:{sourceWidth:486,sourceHeight:326,sourceLeft:7,sourceTop:413},NPCDialog:{sourceWidth:766,sourceHeight:248,sourceLeft:22,sourceTop:756}},icons:{closeW:{sourceWidth:32,sourceHeight:32,sourceLeft:942,sourceTop:306},closeD:{sourceWidth:32,sourceHeight:32,sourceLeft:986,sourceTop:306},closeWLarge:{sourceWidth:64,sourceHeight:64,sourceLeft:512,sourceTop:381},closeDLarge:{sourceWidth:64,sourceHeight:64,sourceLeft:583,sourceTop:381},closeWNoBack:{sourceWidth:24,sourceHeight:24,sourceLeft:946,sourceTop:252},closeDNoBack:{sourceWidth:24,sourceHeight:24,sourceLeft:946,sourceTop:214},closeWNoBackLarge:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:214},closeDNoBackLarge:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:260},FDark:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:4},FWhite:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:4},EDark:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:40},EWhite:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:40},Timer:{sourceWidth:24,sourceHeight:32.2,sourceLeft:718,sourceTop:388},TimerLarge:{sourceWidth:48,sourceHeight:68,sourceLeft:662,sourceTop:386},ClickWhite:{sourceWidth:32,sourceHeight:48,sourceLeft:799,sourceTop:389},ClickDark:{sourceWidth:32,sourceHeight:48,sourceLeft:757,sourceTop:389}},checkboxes:{wOff:{sourceWidth:24,sourceHeight:24,sourceLeft:987,sourceTop:76},wOn:{sourceWidth:24,sourceHeight:24,sourceLeft:987,sourceTop:104},dOff:{sourceWidth:24,sourceHeight:24,sourceLeft:958,sourceTop:76},dOn:{sourceWidth:24,sourceHeight:24,sourceLeft:958,sourceTop:104},wLargeOff:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:132},wLargeOn:{sourceWidth:32,sourceHeight:32,sourceLeft:987,sourceTop:168},dLargeOff:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:132},dLargeOn:{sourceWidth:32,sourceHeight:32,sourceLeft:950,sourceTop:168}},switches:{roundOff:{sourceWidth:64,sourceHeight:32,sourceLeft:783,sourceTop:454},roundRed:{sourceWidth:64,sourceHeight:32,sourceLeft:853,sourceTop:454},roundGreen:{sourceWidth:64,sourceHeight:32,sourceLeft:923,sourceTop:454},squareOff:{sourceWidth:64,sourceHeight:32,sourceLeft:783,sourceTop:501},squareRed:{sourceWidth:64,sourceHeight:32,sourceLeft:852,sourceTop:501},squareGreen:{sourceWidth:64,sourceHeight:32,sourceLeft:921,sourceTop:501}}},C=function(){function t(t,i){var o=this;v.createAndAddToEngine(),this.elapsedTime=0,this.targetTime=t,this.onTimeReachedCallback=i,this.onTargetTimeReached=function(t){o.onTimeReachedCallback(),t.removeComponent(e)}}var e;return e=t,t.prototype.setCallback=function(t){this.onTimeReachedCallback=t},t=e=o([Component("npcTimerDelay")],t)}(),w=engine.getComponentGroup(C),v=function(){function t(){t._instance=this}return t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.update=function(t){var e,i;try{for(var o=n(w.entities),r=o.next();!r.done;r=o.next()){var s=r.value,a=s.getComponent(C);a.elapsedTime+=t,a.elapsedTime>=a.targetTime&&a.onTargetTimeReached(s)}}catch(t){e={error:t}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}},t._instance=null,t}();!function(t){t[t.Confirm=0]="Confirm",t[t.Cancel=1]="Cancel",t[t.Next=2]="Next",t[t.Button3=3]="Button3",t[t.Button4=4]="Button4"}(y||(y={}));var A=-350,x=350,S=function(){function e(e,i,o){var n=this;this.NPCScript=[],this.isDialogOpen=!1,this.isQuestionPanel=!1,this.isFixedScreen=!1,this.activeTextId=0,this.UIOpenTime=0,this.defaultSound=null,this.canvas=h,this.ClickAction=null,this.EButtonAction=null,this.FButtonAction=null,this.defaultPortrait=e||null,this.uiTheme=i instanceof Texture?i:1==i?f:d,this.container=new UIContainerRect(h),this.container.adaptWidth=!0,this.container.width="100%",this.container.vAlign="bottom",this.container.positionY=140,this.container.visible=!1,this.panel=new UIImage(this.container,this.uiTheme),m(this.panel,T.backgrounds.NPCDialog),this.panel.width=766,this.panel.height=248,this.panel.onClick=new OnClick((function(){n.confirmText(y.Next)})),this.defaultPortraitTexture=new Texture(e?e.path:this.uiTheme.src),this.portrait=new UIImage(this.container,this.defaultPortraitTexture),this.portrait.sourceWidth=e&&e.section?e.section.sourceWidth:256,this.portrait.sourceHeight=e&&e.section?e.section.sourceHeight:256,this.portrait.width=e&&e.width?e.width:256,this.portrait.height=e&&e.height?e.height:256,this.portrait.positionX=e&&e.offsetX?e.offsetX+A:A,this.portrait.positionY=e&&e.offsetY?e.offsetY+0:0,this.portrait.onClick=new OnClick((function(){n.confirmText(y.Next)})),this.image=new UIImage(this.container,new Texture(this.uiTheme.src)),this.image.sourceWidth=256,this.image.sourceHeight=256,this.image.sourceTop=0,this.image.sourceLeft=0,this.image.width=256,this.image.height=256,this.image.positionX=x,this.image.positionY=50,this.image.onClick=new OnClick((function(){n.confirmText(y.Next)})),this.text=new UIText(this.container),this.text.adaptWidth=!1,this.text.textWrapping=!0,this.text.width=450,this.text.positionX=20,this.text.hAlign="center",this.text.vAlign="center",this.text.font=p,this.text.fontSize=24,this.text.hTextAlign="center",this.text.vTextAlign="center",this.text.positionY=10,this.text.fontWeight="normal",this.text.color=i?Color4.White():Color4.Black(),this.text.isPointerBlocker=!1,this.soundEnt=new Entity,this.soundEnt.addComponent(new Transform),engine.addEntity(this.soundEnt),this.soundEnt.setParent(Attachable.AVATAR),o&&(this.soundEnt.addComponent(new AudioSource(new AudioClip(o))),this.soundEnt.getComponent(AudioSource).volume=.5,this.defaultSound=o),this.button1=new k(this.container,this.uiTheme,"yes",150,-65,(function(){n.confirmText(y.Confirm)}),!1,t.ButtonStyles.E),this.button1.hide(),this.button2=new k(this.container,this.uiTheme,"no",-80,-65,(function(){n.confirmText(y.Cancel)}),!1,t.ButtonStyles.F),this.button2.hide(),this.button3=new k(this.container,this.uiTheme,"maybe",-80,-80,(function(){n.confirmText(y.Button3)}),!1,t.ButtonStyles.DARK),this.button3.hide(),this.button4=new k(this.container,this.uiTheme,"maybe",150,-80,(function(){n.confirmText(y.Button4)}),!1,t.ButtonStyles.DARK),this.button4.hide(),this.leftClickIcon=new UIImage(this.container,this.uiTheme),this.leftClickIcon.width=32,this.leftClickIcon.height=48,this.leftClickIcon.positionX=340,this.leftClickIcon.positionY=-80,this.leftClickIcon.visible=!1,m(this.leftClickIcon,f?T.icons.ClickWhite:T.icons.ClickDark),E.createAndAddToEngine()}return e.prototype.openDialogWindow=function(t,e){var i=this;this.UIOpenTime=+Date.now(),this.NPCScript=t,this.activeTextId=e?"number"==typeof e?e:W(t,e):0;var o=t[this.activeTextId]?t[this.activeTextId]:{text:""};if(o.audio?(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(o.audio))),this.soundEnt.getComponent(AudioSource).volume=.5,this.soundEnt.getComponent(AudioSource).playOnce()):this.defaultSound&&(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(this.defaultSound))),this.soundEnt.getComponent(AudioSource).playOnce()),o.portrait?(this.portrait.source=new Texture(o.portrait.path),this.portrait.positionX=o.portrait.offsetX?o.portrait.offsetX+A:A,this.portrait.positionY=o.portrait.offsetY?o.portrait.offsetY+0:0,this.portrait.width=o.portrait.width?o.portrait.width:256,this.portrait.height=o.portrait.height?o.portrait.height:256,o.portrait.section&&m(this.portrait,o.portrait.section),this.portrait.visible=!0):this.defaultPortrait?(this.portrait.source=this.defaultPortraitTexture,this.portrait.positionX=this.defaultPortrait&&this.defaultPortrait.offsetX?this.defaultPortrait.offsetX+A:A,this.portrait.positionY=this.defaultPortrait&&this.defaultPortrait.offsetY?this.defaultPortrait.offsetY+0:0,this.portrait.width=this.defaultPortrait&&this.defaultPortrait.width?this.defaultPortrait.width:256,this.portrait.height=this.defaultPortrait&&this.defaultPortrait.height?this.defaultPortrait.height:256,this.defaultPortrait.section&&m(this.portrait,this.defaultPortrait.section),this.portrait.visible=!0):(log("No portrait"),this.portrait.visible=!1),o.image){var n=o.image;log("setting image to ",n.path),this.image.source=new Texture(n.path),this.image.positionX=n.offsetX?n.offsetX+x:x,this.image.positionY=n.offsetY?n.offsetY+50:50,this.image.width=n.width?n.width:256,this.portrait.height=n.height?n.height:256,n.section&&m(this.image,n.section),this.image.visible=!0}else this.image.visible=!1;this.text.fontSize=o.fontSize?o.fontSize:24,this.text.positionY=o.offsetY?o.offsetY+10:10,this.text.positionX=o.offsetX?o.offsetX:0,this.text.visible=!0,this.container.visible=!0,E._instance.newText(this,o.text,this.activeTextId,o.typeSpeed?o.typeSpeed:void 0),this.ClickAction||(this.ClickAction=Input.instance.subscribe("BUTTON_DOWN",ActionButton.POINTER,!1,(function(t){!i.isDialogOpen||+Date.now()-i.UIOpenTime<100||(E._instance.done?i.isQuestionPanel||i.isFixedScreen||i.confirmText(y.Next):E._instance.rush())})),this.EButtonAction=Input.instance.subscribe("BUTTON_DOWN",ActionButton.PRIMARY,!1,(function(t){i.isDialogOpen&&i.isQuestionPanel&&E._instance.done&&+Date.now()-i.UIOpenTime>100&&i.confirmText(y.Confirm)})),this.FButtonAction=Input.instance.subscribe("BUTTON_DOWN",ActionButton.SECONDARY,!1,(function(t){i.isDialogOpen&&i.isQuestionPanel&&E._instance.done&&+Date.now()-i.UIOpenTime>100&&i.confirmText(y.Cancel)}))),this.layoutDialogWindow(this.activeTextId),this.isDialogOpen=!0},e.prototype.confirmText=function(t){var e=this.NPCScript[this.activeTextId];if(t==y.Next&&!e.isQuestion){if(e.triggeredByNext&&e.triggeredByNext(),e.isEndOfDialog)return void this.closeDialogWindow();this.activeTextId++}t==y.Confirm&&e.buttons&&e.buttons.length>=1&&("number"==typeof e.buttons[0].goToDialog?this.activeTextId=e.buttons[0].goToDialog:this.activeTextId=W(this.NPCScript,e.buttons[0].goToDialog),e.buttons[0].triggeredActions&&e.buttons[0].triggeredActions()),t==y.Cancel&&e.buttons&&e.buttons.length>=2&&("number"==typeof e.buttons[1].goToDialog?this.activeTextId=e.buttons[1].goToDialog:this.activeTextId=W(this.NPCScript,e.buttons[1].goToDialog),e.buttons[1].triggeredActions&&e.buttons[1].triggeredActions()),t==y.Button3&&e.buttons&&e.buttons.length>=3&&("number"==typeof e.buttons[2].goToDialog?this.activeTextId=e.buttons[2].goToDialog:this.activeTextId=W(this.NPCScript,e.buttons[2].goToDialog),e.buttons[2].triggeredActions&&e.buttons[2].triggeredActions()),t==y.Button4&&e.buttons&&e.buttons.length>=4&&("number"==typeof e.buttons[3].goToDialog?this.activeTextId=e.buttons[3].goToDialog:this.activeTextId=W(this.NPCScript,e.buttons[3].goToDialog),e.buttons[3].triggeredActions&&e.buttons[3].triggeredActions()),e=this.NPCScript[this.activeTextId],E._instance.newText(this,e.text,this.activeTextId,e.typeSpeed?e.typeSpeed:void 0)},e.prototype.layoutDialogWindow=function(t){var e=this,i=this.NPCScript[t]?this.NPCScript[t]:{text:""},o=i.offsetY?i.offsetY+10:10;if(i.buttons&&i.buttons.length>=3?o+=50:i.buttons&&i.buttons.length>=1&&(o+=24),this.text.fontSize=i.fontSize?i.fontSize:24,this.text.positionY=o,i.audio?(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(i.audio))),this.soundEnt.getComponent(AudioSource).volume=.5,this.soundEnt.getComponent(AudioSource).playOnce()):this.defaultSound&&(this.soundEnt.addComponentOrReplace(new AudioSource(new AudioClip(this.defaultSound))),this.soundEnt.getComponent(AudioSource).playOnce()),i.portrait?(this.portrait.source=new Texture(i.portrait.path),this.portrait.positionX=i.portrait.offsetX?i.portrait.offsetX+A:A,this.portrait.positionY=i.portrait.offsetY?i.portrait.offsetY+0:0,this.portrait.width=i.portrait.width?i.portrait.width:256,this.portrait.height=i.portrait.height?i.portrait.height:256,i.portrait.section&&m(this.portrait,i.portrait.section),this.portrait.visible=!0):this.defaultPortrait?(this.portrait.source=new Texture(this.defaultPortrait.path),this.portrait.positionX=this.defaultPortrait&&this.defaultPortrait.offsetX?this.defaultPortrait.offsetX+A:A,this.portrait.positionY=this.defaultPortrait&&this.defaultPortrait.offsetY?this.defaultPortrait.offsetY+0:0,this.portrait.width=this.defaultPortrait&&this.defaultPortrait.width?this.defaultPortrait.width:256,this.portrait.height=this.defaultPortrait&&this.defaultPortrait.height?this.defaultPortrait.height:256,this.defaultPortrait.section&&m(this.portrait,this.defaultPortrait.section),this.portrait.visible=!0):(log("No portrait"),this.portrait.visible=!1),this.image.visible=!1,i.image){var n=i.image;log("setting image to ",n.path),this.image.source=new Texture(n.path),this.image.positionX=n.offsetX?n.offsetX+x:x,this.image.positionY=n.offsetY?n.offsetY+50:50,this.image.width=i.image.width?i.image.width:256,this.image.height=i.image.height?i.image.height:256,n.section&&m(this.image,n.section),this.image.visible=!0}else this.image.visible=!1;this.isQuestionPanel=!!i.isQuestion&&i.isQuestion,this.isFixedScreen=!!i.isFixedScreen&&i.isFixedScreen,this.button1.hide(),this.button2.hide(),this.button3.hide(),this.button4.hide(),this.leftClickIcon.visible=!1,i.isQuestion?(i.buttons&&i.buttons.length>=1&&this.button1.update(i.buttons[0].label,i.buttons[0].offsetX?i.buttons[0].offsetX+150:150,i.buttons.length>=3?i.buttons[0].offsetY?i.buttons[0].offsetY+-20:-20:i.buttons[0].offsetY?i.buttons[0].offsetY+-65:-65),i.buttons&&i.buttons.length>=2&&this.button2.update(i.buttons[1].label,i.buttons[1].offsetX?i.buttons[1].offsetX+-80:-80,i.buttons.length>=3?i.buttons[1].offsetY?i.buttons[1].offsetY+-20:-20:i.buttons[1].offsetY?i.buttons[1].offsetY+-65:-65),i.buttons&&i.buttons.length>=3&&this.button3.update(i.buttons[2].label,i.buttons[2].offsetX?i.buttons[2].offsetX+-80:-80,i.buttons[2].offsetY?i.buttons[2].offsetY+-80:-80),i.buttons&&i.buttons.length>=4&&this.button4.update(i.buttons[3].label,i.buttons[3].offsetX?i.buttons[3].offsetX+150:150,i.buttons[3].offsetY?i.buttons[3].offsetY+-80:-80),D.addComponentOrReplace(new C(.7,(function(){i.buttons&&i.buttons.length>=1&&e.button1.show(),i.buttons&&i.buttons.length>=2&&e.button2.show(),i.buttons&&i.buttons.length>=3&&e.button3.show(),i.buttons&&i.buttons.length>=4&&e.button4.show()})))):this.isFixedScreen||(this.leftClickIcon.visible=!0)},e.prototype.closeDialogWindow=function(){this.isDialogOpen&&(this.isDialogOpen=!1,this.portrait.visible=!1,this.text.value="",this.text.visible=!1,this.button1.hide(),this.button2.hide(),this.button3.hide(),this.button4.hide(),this.leftClickIcon.visible=!1,this.container.visible=!1)},e}(),E=function(){function t(){this.timer=0,this.speed=30,this.visibleChars=0,this.fullText="",this.UIText=null,this.done=!0,t._instance=this}return t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.update=function(t){if(!this.done&&(this.timer+=t,this.timer>=2/this.speed)){var e=Math.floor(this.timer/(1/this.speed));this.timer=0,this.visibleChars+=e,this.visibleChars>=this.fullText.length&&(this.done=!0,this.visibleChars=this.fullText.length),this.UIText&&(this.UIText.value=this.fullText.substr(0,this.visibleChars))}},t.prototype.newText=function(t,e,i,o){this.timer=0,this.done=!1,this.UIText=t.text,this.fullText=e,this.visibleChars=0,o&&o<=0?this.rush():this.speed=o||30,t.layoutDialogWindow(i)},t.prototype.rush=function(){this.done=!0,this.timer=0,this.visibleChars=this.fullText.length,this.UIText&&(this.UIText.value=this.fullText)},t._instance=null,t}(),k=function(e){function o(i,o,n,r,s,a,u,h){var l=e.call(this)||this;if(l.icon=null,l.image=new UIImage(i,o),l.image.positionX=r,l.image.positionY=s,l.image.width=174,l.image.height=46,l.label=new UIText(l.image),l.style=h||null,l.onClick=a,l.style)switch(l.style){case t.ButtonStyles.E:m(l.image,T.buttons.buttonE),l.label.positionX=25,l.icon=new UIImage(l.image,1==u?f:d),l.icon.width=26,l.icon.height=26,l.icon.hAlign="center",l.icon.vAlign="center",l.icon.isPointerBlocker=!1,m(l.icon,T.buttonLabels.E),l.icon.positionX=b(n.length);break;case t.ButtonStyles.F:m(l.image,T.buttons.buttonF),l.label.positionX=25,l.icon=new UIImage(l.image,1==u?f:d),l.icon.width=26,l.icon.height=26,l.icon.hAlign="center",l.icon.vAlign="center",l.icon.isPointerBlocker=!1,m(l.icon,T.buttonLabels.F),l.icon.positionX=b(n.length);break;case t.ButtonStyles.RED:m(l.image,T.buttons.buttonRed);break;case t.ButtonStyles.DARK:m(l.image,T.buttons.buttonDark);break;case t.ButtonStyles.ROUNDBLACK:m(l.image,T.buttons.roundBlack);break;case t.ButtonStyles.ROUNDWHITE:m(l.image,T.buttons.roundWhite);break;case t.ButtonStyles.ROUNDSILVER:m(l.image,T.buttons.roundSilver);break;case t.ButtonStyles.ROUNDGOLD:m(l.image,T.buttons.roundGold);break;case t.ButtonStyles.SQUAREBLACK:m(l.image,T.buttons.squareBlack);break;case t.ButtonStyles.SQUAREWHITE:m(l.image,T.buttons.squareWhite);break;case t.ButtonStyles.SQUARESILVER:m(l.image,T.buttons.squareSilver);break;case t.ButtonStyles.SQUAREGOLD:m(l.image,T.buttons.squareGold)}else m(l.image,T.buttons.roundSilver);return l.label.value=n,l.label.hTextAlign="center",l.label.vTextAlign="center",l.label.fontSize=20,l.label.font=g,l.label.color=h==t.ButtonStyles.ROUNDWHITE||h==t.ButtonStyles.SQUAREWHITE?Color4.Black():Color4.White(),l.label.isPointerBlocker=!1,l.image.onClick=new OnClick((function(){l.onClick()})),h==t.ButtonStyles.E?Input.instance.subscribe("BUTTON_DOWN",ActionButton.PRIMARY,!1,(function(t){l.image.visible&&l.onClick()})):h==t.ButtonStyles.F&&Input.instance.subscribe("BUTTON_DOWN",ActionButton.SECONDARY,!1,(function(t){l.image.visible&&l.onClick()})),l}return i(o,e),o.prototype.hide=function(){this.image.visible=!1},o.prototype.show=function(){this.image.visible=!0},o.prototype.grayOut=function(){this.label.color=Color4.Gray(),this.image.isPointerBlocker=!1},o.prototype.enable=function(){this.label.color=Color4.White(),this.image.isPointerBlocker=!0},o.prototype.update=function(e,i,o){this.label.value=e,this.image.positionX=i,this.image.positionY=o,!this.icon||this.style!=t.ButtonStyles.E&&this.style!=t.ButtonStyles.F||(this.icon.positionX=b(e.length))},o}(Entity),D=new Entity;function W(t,e){for(var i=0;i<t.length;i++)if(t[i].name&&t[i].name==e)return i;return 0}engine.addEntity(D);var P=function(){function t(){this._triggers={},t._instance=this,this._cameraTriggerWrapper=new O(new I(new Vector3(.5,1.8,.5),new Vector3(0,.91,0))),this._componentGroup=engine.getComponentGroup(L)}return Object.defineProperty(t,"instance",{get:function(){return this.createAndAddToEngine()},enumerable:!1,configurable:!0}),t.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new t,engine.addSystem(this._instance)),this._instance},t.prototype.setCameraTriggerShape=function(t){this._cameraTriggerWrapper.setShape(t)},t.prototype.update=function(){var e=this,i=this._componentGroup.entities;for(var o in i.forEach((function(t){e.shouldWrapTriggerEntity(t)&&e.wrapTriggerEntity(t)})),this._triggers)if(this._triggers.hasOwnProperty(o)){var n=this._triggers[o];n.isDebugging()&&n.updateDebugEntity(),n.isInEngine()?null!=n.trigger&&n.trigger.enabled?(n.wasEnabled||n.isDebugging()&&n.addDebugEntity(),n.wasEnabled=!0,(n.trigger.onCameraEnter||n.trigger.onCameraExit)&&this.checkCollisionAgainstCamera(n),(n.trigger.onTriggerEnter||n.trigger.onTriggerExit)&&this.checkCollisionAgainstOtherTriggers(n)):n.wasEnabled&&(n.wasEnabled=!1,n.isDebugging()&&n.removeDebugEntity(),t.removeTriggerFromSystem(n)):(n.isDebugging()&&n.removeDebugEntity(),t.removeTriggerFromSystem(n),delete this._triggers[o])}},t.prototype.shouldWrapTriggerEntity=function(t){return null==this._triggers[t.uuid]||null==this._triggers[t.uuid]},t.prototype.wrapTriggerEntity=function(t){this._triggers[t.uuid]=new _(t)},t.removeTriggerFromSystem=function(e){for(var i,o=e.getActiveCollisions(),n=0;n<o.length;n++){!(o[n]===(null===(i=t._instance)||void 0===i?void 0:i._cameraTriggerWrapper)||null==o[n].trigger)&&o[n].trigger.onTriggerExit&&e.entity&&o[n].trigger.onTriggerExit(e.entity),o[n].disengageActiveCollision(e),e.disengageActiveCollision(o[n])}},t.disengageCollision=function(t,e){t.disengageActiveCollision(e),e.disengageActiveCollision(t),t.trigger.onTriggerExit&&e.entity&&t.trigger.onTriggerExit(e.entity),e.trigger.onTriggerExit&&t.entity&&e.trigger.onTriggerExit(t.entity)},t.engageCollision=function(t,e){t.engageCollision(e),e.engageCollision(t),t.trigger.onTriggerEnter&&e.entity&&t.trigger.onTriggerEnter(e.entity),e.trigger.onTriggerEnter&&t.entity&&e.trigger.onTriggerEnter(t.entity)},t.prototype.checkCollisionAgainstCamera=function(e){var i=e.hasActiveCollision(this._cameraTriggerWrapper),o=t.areColliding(e,this._cameraTriggerWrapper);i&&!o?(e.disengageActiveCollision(this._cameraTriggerWrapper),e.trigger.onCameraExit&&e.trigger.onCameraExit()):!i&&o&&(e.engageCollision(this._cameraTriggerWrapper),e.trigger.onCameraEnter&&e.trigger.onCameraEnter())},t.prototype.checkCollisionAgainstOtherTriggers=function(e){for(var i in this._triggers)if(this._triggers.hasOwnProperty(i)&&i!=e.uuid&&this._triggers[i].trigger.enabled&&t.canTriggersCollide(e,this._triggers[i])){var o=e.hasActiveCollision(this._triggers[i]),n=t.areColliding(e,this._triggers[i]);o&&!n?t.disengageCollision(e,this._triggers[i]):!o&&n&&t.engageCollision(e,this._triggers[i])}},t.canTriggersCollide=function(t,e){return 0==t.trigger.triggeredByLayer||0!=(e.trigger.layer&t.trigger.triggeredByLayer)},t.areColliding=function(e,i){return e.getShape()instanceof I&&i.getShape()instanceof I?t.areCollidingAABB(e.getGlobalPosition(),e.getShape(),i.getGlobalPosition(),i.getShape()):e.getShape()instanceof B&&i.getShape()instanceof B?t.areCollidingSphere(e.getGlobalPosition(),e.getShape(),i.getGlobalPosition(),i.getShape()):e.getShape()instanceof I&&i.getShape()instanceof B?t.areCollidingAABBSphere(e.getGlobalPosition(),e.getShape(),i.getGlobalPosition(),i.getShape()):e.getShape()instanceof B&&i.getShape()instanceof I&&t.areCollidingAABBSphere(i.getGlobalPosition(),i.getShape(),e.getGlobalPosition(),e.getShape())},t.areCollidingAABB=function(e,i,o,n){var r=t.getBoxShapeValues(e,i),s=t.getBoxShapeValues(o,n);return r.min.x<=s.max.x&&r.max.x>=s.min.x&&r.min.y<=s.max.y&&r.max.y>=s.min.y&&r.min.z<=s.max.z&&r.max.z>=s.min.z},t.areCollidingSphere=function(t,e,i,o){return Vector3.DistanceSquared(t.add(e.position),i.add(o.position))<e.radius*e.radius+o.radius*o.radius},t.areCollidingAABBSphere=function(e,i,o,n){var r=t.getBoxShapeValues(e,i),s=o.add(n.position),a=n.radius,u=0;return s.x<r.min.x&&(u+=(r.min.x-s.x)*(r.min.x-s.x)),s.x>r.max.x&&(u+=(s.x-r.max.x)*(s.x-r.max.x)),s.y<r.min.y&&(u+=(r.min.y-s.y)*(r.min.y-s.y)),s.y>r.max.y&&(u+=(s.y-r.max.y)*(s.y-r.max.y)),s.z<r.min.z&&(u+=(r.min.z-s.z)*(r.min.z-s.z)),s.z>r.max.z&&(u+=(s.z-r.max.z)*(s.z-r.max.z)),u<a*a},t.getBoxShapeValues=function(t,e){var i=t.add(e.position);return{center:i,min:i.subtract(e.size.scale(.5)),max:i.add(e.size.scale(.5))}},t._instance=null,t}(),_=function(){function t(t){this.wasEnabled=!0,this._uuid="",this._collidingWith={},this._isDebug=!1,this._debugEntity=null,this._entity=t,t&&(this._trigger=t.getComponent(L),this._uuid=t.uuid,this._isDebug=this._trigger.debugEnabled,this._isDebug&&this.addDebugEntity())}return Object.defineProperty(t.prototype,"entity",{get:function(){return this._entity},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"trigger",{get:function(){return this._trigger},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"uuid",{get:function(){return this._uuid},enumerable:!1,configurable:!0}),t.prototype.getGlobalPosition=function(){return this._entity?t.getEntityWorldPosition(this._entity):Vector3.Zero()},t.prototype.getShape=function(){return this._trigger.shape},t.prototype.isInEngine=function(){return null!=this._entity&&this._entity.isAddedToEngine()},t.prototype.getActiveCollisions=function(){var t=[];for(var e in this._collidingWith)this._collidingWith.hasOwnProperty(e)&&t.push(this._collidingWith[e]);return t},t.prototype.hasActiveCollision=function(t){return null!=this._collidingWith[t.uuid]&&null!=this._collidingWith[t.uuid]},t.prototype.disengageActiveCollision=function(t){delete this._collidingWith[t.uuid]},t.prototype.engageCollision=function(t){this._collidingWith[t.uuid]=t},t.prototype.isDebugging=function(){return this._isDebug},t.prototype.addDebugEntity=function(){if(t._debugMaterial||(t._debugMaterial=new Material,t._debugMaterial.alphaTest=.5),null==this._debugEntity){this._debugEntity=new Entity;var e=new Transform;if(this._debugEntity.addComponent(e),this._debugEntity.addComponent(t._debugMaterial),this.getShape()instanceof I)(i=new BoxShape).withCollisions=!1,this._debugEntity.addComponent(i),e.scale=this.getShape().size;if(this.getShape()instanceof B){var i;(i=new SphereShape).withCollisions=!1,this._debugEntity.addComponent(i);var o=this.getShape().radius;e.scale=new Vector3(o,o,o)}}engine.addEntity(this._debugEntity)},t.prototype.removeDebugEntity=function(){null!=this._debugEntity&&engine.removeEntity(this._debugEntity)},t.prototype.updateDebugEntity=function(){this._debugEntity&&(this._debugEntity.getComponent(Transform).position=this.getGlobalPosition().add(this.getShape().position))},t.getEntityWorldPosition=function(t){var e=t.hasComponent(Transform)?t.getComponent(Transform).position.clone():Vector3.Zero(),i=t.getParent();if(null!=i){var o=i.hasComponent(Transform)?i.getComponent(Transform).rotation:Quaternion.Identity;return this.getEntityWorldPosition(i).add(e.rotate(o))}return e},t._debugMaterial=null,t}(),O=function(t){function e(e){var i=t.call(this)||this;return i._shape=e,i._uuid="cameraTrigger",i}return i(e,t),e.prototype.getGlobalPosition=function(){return Camera.instance.position},e.prototype.getShape=function(){return this._shape},e.prototype.setShape=function(t){this._shape=t},e.prototype.isInEngine=function(){return!1},e.prototype.hasActiveCollision=function(t){return!1},e.prototype.disengageActiveCollision=function(t){},e.prototype.engageCollision=function(t){},e.prototype.isDebugging=function(){return!1},e}(_),L=function(){function t(t,e){this.enabled=!0,this.layer=0,this.triggeredByLayer=0,P.createAndAddToEngine(),this.shape=t,this.layer=e&&e.layer?e.layer:0,this.triggeredByLayer=e&&e.triggeredByLayer?e.triggeredByLayer:0,this.onTriggerEnter=e&&e.onTriggerEnter?e.onTriggerEnter:void 0,this.onTriggerExit=e&&e.onTriggerExit?e.onTriggerExit:void 0,this.onCameraEnter=e&&e.onCameraEnter?e.onCameraEnter:void 0,this.onCameraExit=e&&e.onCameraExit?e.onCameraExit:void 0,this._debugEnabled=!(!e||!e.enableDebug)&&e.enableDebug}return Object.defineProperty(t.prototype,"debugEnabled",{get:function(){return this._debugEnabled},enumerable:!1,configurable:!0}),t=o([Component("npcTriggerComponent")],t)}(),I=function(t,e){this.size=t,this.position=e},B=function(t,e){this.radius=t,this.position=e},N=function(){function t(t){this.origin=0,this.target=1,this.fraction=0,this.totalDuration=0,this.speed=[],this.loop=!1,this.path=t,H.createAndAddToEngine()}return t.prototype.setIndex=function(t){this.fraction=0,this.origin=t,this.target=t+1<this.path.length?t+1:0},t=o([Component("npclerpData")],t)}(),R=[],H=function(){function e(){e._instance=this}return e.prototype.update=function(e){var i,o;try{for(var r=n(R),s=r.next();!s.done;s=r.next()){var a=s.value;if(a.state==t.NPCState.FOLLOWPATH){var u=a.getComponent(Transform),h=a.getComponent(N);if(h.fraction<1)h.fraction+=e*h.speed[h.origin],u.position=Vector3.Lerp(h.path[h.origin],h.path[h.target],h.fraction);else{if(h.origin=h.target,h.target+=1,h.target>=h.path.length){if(!h.loop)return a.stopWalking(),h.onFinishCallback&&h.onFinishCallback(),void(h.fraction=1);h.target=0}else h.onReachedPointCallback&&h.onReachedPointCallback();h.fraction=0,u.lookAt(h.path[h.target])}}}}catch(t){i={error:t}}finally{try{s&&!s.done&&(o=r.return)&&o.call(r)}finally{if(i)throw i.error}}},e.createAndAddToEngine=function(){return null==this._instance&&(this._instance=new e,engine.addSystem(this._instance)),this._instance},e._instance=null,e}(),U=function(e){function o(i,o,n,s){var a=e.call(this)||this;a.introduced=!1,a.onWalkAway=null,a.continueOnWalkAway=!1,a.inCooldown=!1,a.coolDownDuration=5,a.faceUser=!1,a.walkingAnim=null,a.walkingSpeed=2,a.addComponent(new GLTFShape(o)),a.addComponent(new Transform(i)),engine.addEntity(a),a.state=t.NPCState.STANDING,s&&s.portrait?a.dialog=new S("string"==typeof s.portrait?{path:s.portrait}:s.portrait,!(!s||!s.darkUI)&&s.darkUI,s.dialogSound?s.dialogSound:void 0):a.dialog=new S(void 0,!(!s||!s.darkUI)&&s.darkUI,s&&s.dialogSound?s.dialogSound:void 0),a.addComponent(new Animator),a.idleAnim=new AnimationState(s&&s.idleAnim?s.idleAnim:"Idle",{looping:!0}),a.getComponent(Animator).addClip(a.idleAnim),a.lastPlayedAnim=a.idleAnim,a.idleAnim.play(),s&&s.walkingAnim&&(a.walkingAnim=new AnimationState(s.walkingAnim,{looping:!0}),a.getComponent(Animator).addClip(a.walkingAnim)),a.onActivate=n,s&&s.onWalkAway&&(a.onWalkAway=s.onWalkAway),s&&s.continueOnWalkAway&&(a.continueOnWalkAway=s.continueOnWalkAway),a.endAnimTimer=new Entity,engine.addEntity(a.endAnimTimer),a.closeDialogTimer=new Entity,engine.addEntity(a.closeDialogTimer),a.pauseWalkingTimer=new Entity,engine.addEntity(a.pauseWalkingTimer);var u=s&&s.onlyClickTrigger?ActionButton.POINTER:ActionButton.PRIMARY;return a.addComponent(new OnPointerDown((function(t){a.inCooldown||a.dialog.isDialogOpen||a.activate()}),{button:u,hoverText:s&&s.hoverText?s.hoverText:"Talk",showFeedback:!s||!s.onlyExternalTrigger})),s&&s.onlyExternalTrigger&&a.removeComponent(OnPointerDown),s&&(!s||s.onlyExternalTrigger||s.onlyClickTrigger||s.onlyETrigger)||a.addComponent(new L(new B(s&&s.reactDistance?s.reactDistance:6,Vector3.Zero()),{onCameraEnter:function(){a.inCooldown?log(a.name," in cooldown"):a.dialog.isDialogOpen||s&&s.onlyExternalTrigger||s&&s.onlyClickTrigger||a.activate()},onCameraExit:function(){a.handleWalkAway()}})),s&&s.faceUser&&(a.addComponent(new r(!0,s.turningSpeed?s.turningSpeed:void 0)),a.faceUser=!0),s&&s.walkingSpeed&&(a.walkingSpeed=s.walkingSpeed),s&&s.coolDownDuration&&(a.coolDownDuration=s.coolDownDuration),s&&s.path&&(a.addComponent(new N(s.path?s.path:[])),a.getComponent(N).loop=!0,R.push(a),a.followPath()),a}return i(o,e),o.prototype.activate=function(){var t=this;this.faceUser&&(this.getComponent(r).active=!0),this.inCooldown=!0,this.addComponentOrReplace(new C(this.coolDownDuration,(function(){t.inCooldown=!1}))),this.onActivate()},o.prototype.endInteraction=function(){this.faceUser&&(this.getComponent(r).active=!1),this.dialog.isDialogOpen&&this.dialog.closeDialogWindow(),this.state=t.NPCState.STANDING},o.prototype.handleWalkAway=function(){this.state!=t.NPCState.FOLLOWPATH&&(this.continueOnWalkAway||this.endInteraction(),this.onWalkAway&&this.onWalkAway())},o.prototype.talk=function(e,i,o){var n=this;this.introduced=!0,this.state=t.NPCState.TALKING,this.closeDialogTimer.hasComponent(C)&&this.closeDialogTimer.removeComponent(C),this.dialog.openDialogWindow(e,i||0),o&&this.closeDialogTimer.addComponentOrReplace(new C(o,(function(){n.dialog.closeDialogWindow()})))},o.prototype.playAnimation=function(t,e,i){var o=this;this.lastPlayedAnim.stop(),this.endAnimTimer.hasComponent(C)&&this.endAnimTimer.removeComponent(C);var n=this.getComponent(Animator).getClip(t);e&&(n.looping=!1,i&&this.endAnimTimer.addComponentOrReplace(new C(i,(function(){n.stop(),o.idleAnim&&(o.idleAnim.play(),o.lastPlayedAnim=o.idleAnim)})))),n.stop(),n.play(),this.lastPlayedAnim=n},o.prototype.followPath=function(e){if(!this.hasComponent(N)){if(!e)return;this.addComponent(new N(e.path?e.path:[])),R.push(this)}this.faceUser&&(this.getComponent(r).active=!1);var i=this.getComponent(N);if(e){if(e.path)if(e.curve){var o=Curve3.CreateCatmullRomSpline(e.path,4*e.path.length,!!e.loop).getPoints();e.loop&&o.pop(),i.path=o}else i.path=e.path;null!=e.loop&&(i.loop=e.loop),null!=e.startingPoint&&i.setIndex(e.startingPoint),e.onFinishCallback&&(i.onFinishCallback=e.onFinishCallback),e.onReachedPointCallback&&(i.onReachedPointCallback=e.onReachedPointCallback)}var n=this.getComponent(Transform).position;(0==i.fraction&&i.path[i.origin].subtract(n).lengthSquared()>.1||i.fraction>0&&n.subtract(i.path[i.origin]).normalize()==i.path[i.target].subtract(i.path[i.origin]).normalize())&&(i.path.splice(i.origin,0,this.getComponent(Transform).position),i.fraction=0),this.getComponent(Transform).lookAt(i.path[i.target]);for(var s=0,a=[],u=0;u<i.path.length-1;u++){var h;s+=h=Vector3.Distance(i.path[u],i.path[u+1]),a.push(h)}i.loop&&(s+=h=Vector3.Distance(i.path[i.path.length-1],i.path[0]),a.push(h));e&&e.totalDuration?i.totalDuration=e.totalDuration:e&&e.speed?i.totalDuration=s/e.speed:i.totalDuration||(i.totalDuration=s/this.walkingSpeed),i.speed=[];for(u=0;u<a.length;u++)i.speed.push(1/(a[u]/s*i.totalDuration));this.walkingAnim&&(this.idleAnim.stop(),this.lastPlayedAnim.stop(),this.walkingAnim.play(),this.lastPlayedAnim=this.walkingAnim),this.state=t.NPCState.FOLLOWPATH},o.prototype.stopWalking=function(e){var i=this;this.state=t.NPCState.STANDING,this.walkingAnim&&(this.walkingAnim.stop(),this.idleAnim.play(),this.lastPlayedAnim=this.idleAnim),e&&this.pauseWalkingTimer.addComponentOrReplace(new C(e,(function(){i.dialog.isDialogOpen||(i.lastPlayedAnim.stop(),i.walkingAnim&&(i.walkingAnim.play(),i.lastPlayedAnim=i.walkingAnim),i.endAnimTimer.hasComponent(C)&&i.endAnimTimer.removeComponent(C),i.state=t.NPCState.FOLLOWPATH)})))},o}(Entity);t.CustomDialogButton=k,t.DialogTypeInSystem=E,t.DialogWindow=S,t.NPC=U,t.NPCDelay=C,t.NPCLerpData=N,t.NPCTriggerComponent=L,t.SFFont=g,t.SFHeavyFont=p,t.TrackUserFlag=r,t.TriggerBoxShape=I,t.TriggerSphereShape=B,t.canvas=h,t.darkTheme=f,t.lightTheme=d,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=index.js.map
